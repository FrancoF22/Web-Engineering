<meta charset="UTF-8">
<link rel="stylesheet" href="style/calendario.css" type="text/css" />
<!-- FullCalendar CSS -->
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet' />
<!-- Dipendenze richieste da FullCalendar -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
<!-- FullCalendar script -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>

<div id="calendar"></div>

<!-- Form per la gestione degli eventi -->
<form id="event-form">
    <div class="form-title">Gestisci Eventi</div>
    <label>Aula:</label>
    <select name="aula">
        <#list ListaAule as aula>
        <option value="${aula.key}">${aula.nome}</option>
        </#list>
    </select>
    <label>Evento:</label>
    <select name="evento">
        <#list ListaEventi as evento>
        <option value="${evento.key}">${evento.nome}</option>
        </#list>
    </select>
    <label for="date">Data:</label>
    <input type="date" id="date" name="date">
    <label for="start-time">Ora Inizio:</label>
    <input type="time" id="start-time" name="start-time">
    <label for="end-time">Ora Fine:</label>
    <input type="time" id="end-time" name="end-time">
    <!-- <input type="submit" class="button" value="Salva" name="update"/> -->
    <input type="submit" name="Aggiungi/Modifica Evento">
</form>

<!-- Tabella per visualizzare gli eventi del giorno selezionato -->
<table id="daily-events">
    <thead>
        <tr>
            <th>Evento</th>
            <th>Orario Inizio</th>
            <th>Orario Fine</th>
            <!-- Aggiungi altre colonne se necessario -->
        </tr>
    </thead>
    <tbody>
        <!-- Le righe verranno aggiunte dinamicamente qui -->
    </tbody>
</table>


<script>
    $(document).ready(function () {

        // Funzione per impostare l'ora d'inizio e fine di default
        function setDefaultStartEndTime() {
            var now = new Date();
            var startTime = moment(now).format('HH:mm'); // Ora attuale
            var endTime = moment(now).add(1, 'hours').format('HH:mm'); // Un'ora dopo

            $('#start-time').val(startTime); // Imposta l'ora d'inizio
            $('#end-time').val(endTime); // Imposta l'ora di fine
        }

        // Inizializzazione di FullCalendar
        $('#calendar').fullCalendar({
            // Opzioni di configurazione
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            // Gestione del click su un giorno
            dayClick: function (date, jsEvent, view) {
                var formattedDate = date.format(); // Formatta la data come desideri, ad esempio "YYYY-MM-DD"
                $('#date').val(formattedDate); // Imposta il valore del campo "Data" nel form

                setDefaultStartEndTime(); // Imposta l'ora d'inizio e fine di default
                loadDailyEvents(formattedDate);// Carica e mostra gli eventi di quel giorno nella tabella

                // (Opzionale) Apri una modalità di dialogo o sposta lo scroll alla form
            },
            editable: true, // Rende gli eventi trascinabili e modificabili
            events: fetchEvents // Carica gli eventi tramite la funzione fetchEvents
        });

        function loadDailyEvents(date) {
            // Fai una richiesta per ottenere gli eventi di quel giorno
            fetch('/evento?action=getDailyEvents&date=' + date)
                    .then(response => response.json())
                    .then(events => {
                        updateDailyEventsTable(events);
                    })
                    .catch(error => console.error('Error loading daily events:', error));
        }

        function updateDailyEventsTable(events) {
            var $tableBody = $('#daily-events tbody');
            $tableBody.empty(); // Pulisci la tabella

            events.forEach(event => {
                var $row = $('<tr></tr>');
                $row.append($('<td></td>').text(event.title));
                $row.append($('<td></td>').text(event.startTime));
                $row.append($('<td></td>').text(event.endTime));
                // Aggiungi altre celle se necessario

                $tableBody.append($row);
            });
        }

        // Funzione per recuperare gli eventi dalla servlet
        function fetchEvents(start, end, timezone, callback) {
            // Assumiamo che la tua servlet restituisca dati in un formato testuale o HTML
            fetch('/evento?action=getEvents&start=' + start.format() + '&end=' + end.format())
                    .then(response => response.text())
                    .then(textResponse => {
                        var events = parseEventsFromTextResponse(textResponse);
                        callback(events);
                    })
                    .catch(error => console.error('Error fetching events:', error));
        }

        function parseEventsFromTextResponse(textResponse) {
            // Qui dovrai analizzare il testo della risposta e convertirlo in un array di oggetti evento
            // Questa è una parte complessa e dipende dal formato esatto della tua risposta della servlet
            return []; // Restituire un array di oggetti evento
        }

        $('#event-form').on('submit', function (e) {
            e.preventDefault();
            var eventData = {
                room: $('#room').val(),
                date: $('#date').val(),
                startTime: $('#start-time').val(),
                endTime: $('#end-time').val(),
                // Aggiungi altri campi se necessario
            };

            // Invia i dati dell'evento alla servlet
            submitEvent(eventData);
        });

        function submitEvent(eventData) {
            // Qui dovrai modificare per adattarti al formato di dati atteso dalla tua servlet
            // In questo esempio, inviamo dati come query string, ma potrebbe essere necessario inviare come form data
            fetch('/evento?action=submitEvent&room=' + eventData.room + '&date=' + eventData.date + '&startTime=' + eventData.startTime + '&endTime=' + eventData.endTime, {
                method: 'POST'
            })
                    .then(() => {
                        $('#calendar').fullCalendar('refetchEvents');
                    })
                    .catch(error => console.error('Error submitting event:', error));
        }

        // Gestione del form di invio degli eventi
        $('#event-form').on('submit', function (e) {
            e.preventDefault();

            // Raccogli i dati del form
            var eventData = {
                room: $('#room').val(),
                date: $('#date').val(),
                startTime: $('#start-time').val(),
                endTime: $('#end-time').val(),
                // repetition: $('#repetition').val(), // Aggiungi altri campi se necessario
            };


            setDefaultStartEndTime();// Imposta l'ora d'inizio e fine di default quando la pagina è caricata
            submitEvent(eventData);// Invia i dati dell'evento alla servlet
        });
    });
</script>



